<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orwell - Login</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap">

    <link rel="stylesheet" href="logIn.css">
</head>
<body>
    <div class="login-container">
        <div class="header">
            <div class="logo-section">
                <div class="bill-character" id="billCharacter">
                    <div class="bill-body">
                        <div class="bill-lines">
                            <div class="bill-line"></div>
                            <div class="bill-line"></div>
                            <div class="bill-line"></div>
                            <div class="bill-line"></div>
                        </div>
                        <div class="bill-arm arm-left"></div>
                        <div class="bill-arm arm-right"></div>
                        <div class="bill-leg leg-left"></div>
                        <div class="bill-leg leg-right"></div>
                        <div class="bill-face">
                            <div class="bill-eye eye-left"></div>
                            <div class="bill-eye eye-right"></div>
                            <div class="bill-smile"></div>
                        </div>
                    </div>
                    <div class="bill-helmet">
                        <div class="helmet-star">‚≠ê</div>
                        <div class="helmet-rim"></div>
                    </div>
                </div>
                <h1 class="title">Orwell</h1>
            </div>
            <p class="subtitle">Sign in to explore legislative insights</p>
        </div>

        <form id="sign-in-form">
            <div class="form-group">
                <label for="username">Username</label>
                <input 
                    type="text" 
                    id="username" 
                    name="username" 
                    placeholder="Enter your username"
                    required
                    autocomplete="username"
                >
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    placeholder="Enter your password"
                    required
                    autocomplete="current-password"
                >
            </div>

            <button type="submit" class="submit-btn">Sign In</button>
        </form>

        <div id="message"></div>

        <p class="footer-text">
            Making legislation accessible, one bill at a time
        </p>
        <p class="footer-text" style="margin-top: 1rem;">
            Don't have an account? <a href="signup.html" style="color: #083a5c; font-weight: 600; text-decoration: none; border-bottom: 1px solid #083a5c;">Sign up here</a>
        </p>
    </div>

    <!-- Audio element for trumpet fanfare -->
    <audio id="fanfare" preload="auto">
        <source src="trumpet-fanfare.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getDatabase, ref } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";
        import { get, child, update } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCS07UgX2GnmuufEQET-RYOtm8i0XaZkWk",
            authDomain: "orwell-ea558.firebaseapp.com",
            databaseURL: "https://orwell-ea558-default-rtdb.firebaseio.com",
            projectId: "orwell-ea558",
            storageBucket: "orwell-ea558.firebasestorage.app",
            messagingSenderId: "301391502605",
            appId: "1:301391502605:web:67c58902e72044cd03a444"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const form = document.getElementById('sign-in-form');
        const message = document.getElementById('message');
        const billCharacter = document.getElementById('billCharacter');
        const fanfare = document.getElementById('fanfare');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            let loggedIn = false;
            try {
                const snapshot = await get(child(ref(db), 'users'));

                if (snapshot.exists()) {
                    const users = snapshot.val();
                    loggedIn = false;

                    for (const key in users) {
                        if (
                            users[key].name === username &&
                            users[key].password === password
                        ) {
                            loggedIn = true;
                            await update(ref(db, `users/${key}`), { active: true });
                            break;
                        } else { 
                            await update(ref(db, `users/${key}`), { active: false }); 
                        }
                    }

                    if (loggedIn) {
                        message.textContent = "Login successful! Redirecting...";
                        message.className = 'show success';
                        
                        // Trigger celebration animation
                        billCharacter.classList.add('celebrating');
                        
                        // Play trumpet fanfare
                        try {
                            fanfare.play().catch(err => {
                                console.log('Audio playback failed:', err);
                            });
                        } catch (err) {
                            console.log('Audio playback error:', err);
                        }
                        
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 3100);
                    } else {
                        message.textContent = "Invalid username or password.";
                        message.className = 'show error';
                    }

                } else {
                    message.textContent = "No users found in database.";
                    message.className = 'show error';
                }

            } catch (error) {
                console.error(error);
                message.textContent = "Error connecting to database.";
                message.className = 'show error';
            }
        });
    </script>
</body>
</html>