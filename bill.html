<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Orwell</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="bill.css">
  <link rel="stylesheet" href="quiz-animations.css">
  
</head>
<body>
  <!-- Bill Character with Helmet -->
  <div id="billAnimation">
    <div class="bill-character">
      <div class="bill-body">
        <div class="bill-lines">
          <div class="bill-line"></div>
          <div class="bill-line"></div>
          <div class="bill-line"></div>
          <div class="bill-line"></div>
        </div>
        <div class="bill-arm arm-left"></div>
        <div class="bill-arm arm-right"></div>
        <div class="bill-leg leg-left"></div>
        <div class="bill-leg leg-right"></div>
        <div class="bill-face">
          <div class="bill-eye eye-left"></div>
          <div class="bill-eye eye-right"></div>
          <div class="bill-smile"></div>
        </div>
      </div>
      <div class="bill-helmet">
        <div class="helmet-star">‚≠ê</div>
        <div class="helmet-rim"></div>
      </div>
    </div>
  </div>

  <div id="bill-details">Loading...</div>

  <div class="row2">
    <div class="summary">
      <h2>Bill at a Glance </h2>
      <div id="concise">ML generated summary that Tanush is supposed to generate goes here</div>
    </div>

    <div class="sentiment-analysis">
      <h2>Orwell's Media Sentiment Analysis</h2>

      <div class="sentiment-bar" id="bbc-section">
        <div class="source-title">BBC News</div>
        <div class="bar">
          <div id="bbc-bar" class="fill bbc-color" style="width: 0%"></div>
        </div>
        <div class="confidence-text" id="bbc-confidence">Confidence: Loading...</div>
        <div class="themes" id="bbc-themes">focus topics: Loading...</div>
      </div>

      <div class="sentiment-bar" id="reuters-section">
        <div class="source-title">Reuters</div>
        <div class="bar">
          <div id="reuter-bar" class="fill reuter-color" style="width: 0%"></div>
        </div>
        <div class="confidence-text" id="reuter-confidence">Confidence: Loading...</div>
        <div class="themes" id="reuter-themes">focus topics: Loading...</div>
      </div>
    </div>
  </div>

  <div class="personal-impact">
    <div class="impact-header">
      <h2>Impact</h2>
      <div class="impact-filters">
        <button class="impact-filter-btn" data-filter="direct">Directly Affects You</button>
        <button class="impact-filter-btn" data-filter="indirect">Indirectly Affects You</button>
        <button class="impact-filter-btn" data-filter="none">Affects Your Community</button>
      </div>
    </div>
    <div class="impact-content" id="impact-content">
      <p id="personal-impact">Loading impact data...</p>
    </div>
  </div>

  <div class="row-3">
    <div class="gen-quiz">
      <h2>Quiz</h2>
      <div id="quiz-container">
        <div class="quiz-card-container">
          <div class="quiz-card" id="quiz-card">
            <div class="quiz-card-front">
              <p id="quiz-question" class="quiz-question-text">Loading question...</p>
              <button id="show-answer-btn" class="quiz-btn primary-btn">Show Answer</button>
            </div>
            <div class="quiz-card-back">
              <p id="quiz-answer" class="quiz-answer-text"></p>
              <div id="quiz-controls" class="quiz-controls">
                <button id="correct-btn" class="quiz-btn correct-btn">‚úì I was right</button>
                <button id="wrong-btn" class="quiz-btn wrong-btn">‚úó I was wrong</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Celebration Bill Animation -->
        <div id="celebration-bill" class="celebration-bill">
          <div class="bill-character celebration">
            <div class="bill-body">
              <div class="bill-lines">
                <div class="bill-line"></div>
                <div class="bill-line"></div>
                <div class="bill-line"></div>
                <div class="bill-line"></div>
              </div>
              <div class="bill-arm arm-left"></div>
              <div class="bill-arm arm-right"></div>
              <div class="bill-leg leg-left"></div>
              <div class="bill-leg leg-right"></div>
              <div class="bill-face">
                <div class="bill-eye eye-left"></div>
                <div class="bill-eye eye-right"></div>
                <div class="bill-smile"></div>
              </div>
            </div>
            <div class="bill-helmet">
              <div class="helmet-star">‚≠ê</div>
              <div class="helmet-rim"></div>
            </div>
          </div>
          <div class="celebration-text">+10 Points!</div>
        </div>
        
        <div class="quiz-info">
          <p id="quiz-progress" class="quiz-progress"></p>
          <p id="quiz-points" class="quiz-points"></p>
        </div>
      </div>
    </div>

    <div class="poll-container">
      <h2 class="poll-title"> Orwell Community Vote</h2>
      <div class="poll-content-row">
        <div class="poll-details">
          <div class="poll-buttons">
            <button class="poll-btn approve-btn" id="approveButton">Approve</button>
            <button class="poll-btn disapprove-btn" id="disapproveButton">Disapprove</button>
          </div>
          <div class="poll-bar-container">
            <div class="poll-bar approve-bar" style="width: 0%;"></div>
            <div class="poll-bar disapprove-bar" style="width: 0%;"></div>
          </div>
          <p class="poll-result">0% Approve, 0% Disapprove</p>
        </div>

        <div class="pie-chart-container">
          <canvas id="votePieChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">

    function normalizeText(str) {
      return str
        .replace(/['"]/g, '')
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase();
    }

    let billTitle = ""
    let currentImpactType = ""; // Store the impact type from Firebase
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCS07UgX2GnmuufEQET-RYOtm8i0XaZkWk",
      authDomain: "orwell-ea558.firebaseapp.com",
      databaseURL: "https://orwell-ea558-default-rtdb.firebaseio.com",
      projectId: "orwell-ea558",
      storageBucket: "orwell-ea558.firebasestorage.app",
      messagingSenderId: "301391502605",
      appId: "1:301391502605:web:67c58902e72044cd03a444"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const container = document.getElementById('bill-details');
    const billId = getQueryParam("id") || "unknownBill";
    const billRef = ref(db, "votes/" + billId);

    const pollContainer = document.querySelector(".poll-container");
    const approveBtn = document.getElementById('approveButton');
    const disapproveBtn = document.getElementById('disapproveButton');
    const pollResult = pollContainer.querySelector(".poll-result");
    const approveBar = pollContainer.querySelector(".approve-bar");
    const disapproveBar = pollContainer.querySelector(".disapprove-bar");

    // Impact filter functionality
    const filterButtons = document.querySelectorAll('.impact-filter-btn');
    const impactContent = document.getElementById('impact-content');
    const personalImpactEl = document.getElementById('personal-impact');

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Only allow clicking if it's not disabled
        if (button.classList.contains('disabled')) {
          return;
        }
        
        // Remove active class from all buttons
        filterButtons.forEach(btn => btn.classList.remove('active'));
        
        // Add active class to clicked button
        button.classList.add('active');
        
        // Get filter type
        const filterType = button.dataset.filter;
        
        // Update content based on filter
        updateImpactContent(filterType);
      });
    });

    function titleToQuizKey(title) {
      return title
        .toLowerCase()
        .replace(/[^\w\s]/g, '')   // remove punctuation
        .replace(/\s+/g, '-');     // replace spaces with dashes
    }


    function updateImpactContent(filterType) {
      if (filterType === 'direct') {
        impactContent.innerHTML = '<div class="impact-message">This bill has no direct impact on you.</div>';
      } else if (filterType === 'indirect') {
        // Show the personal impact data
        impactContent.innerHTML = '<p id="personal-impact">Loading personal impact data...</p>';
        loadPersonal();
      } else if (filterType === 'none') {
        impactContent.innerHTML = '<div class="impact-message">This bill has no impact on your community</div>';
      }
    }

    let chartInstance = null;

    async function updatePollDisplay() {
      try {
        const snapshot = await get(billRef);
        let approveVotes = 0;
        let disapproveVotes = 0;

        if (snapshot.exists()) {
          const data = snapshot.val();
          approveVotes = data.approve || 0;
          disapproveVotes = data.disapprove || 0;
        }

        const total = approveVotes + disapproveVotes;
        const approvePercent = total === 0 ? 0 : Math.round((approveVotes / total) * 100);
        const disapprovePercent = total === 0 ? 0 : Math.round((disapproveVotes / total) * 100);

        pollResult.textContent = `${approvePercent}% Approve, ${disapprovePercent}% Disapprove`;

        approveBar.style.width = approvePercent + "%";
        disapproveBar.style.width = disapprovePercent + "%";

        const ctx = document.getElementById("votePieChart").getContext("2d");

        if (chartInstance) {
          chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
          type: "pie",
          data: {
            labels: ["Approve", "Disapprove"],
            datasets: [{
              data: [approveVotes, disapproveVotes],
              backgroundColor: ["#5c7cd1", "#d17a5c"],
              borderWidth: 2,
              borderColor: "#fff"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: "bottom",
                labels: {
                  color: "#6c757d",
                  font: { size: 12, family: "'Inter', sans-serif" },
                  padding: 15
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const percent = total === 0 ? 0 : Math.round((value / total) * 100);
                    return `${label}: ${value} (${percent}%)`;
                  }
                }
              }
            }
          }
        });
      } catch (err) {
        console.error("Error loading poll data:", err);
      }
    }

    function triggerBillMarch() {
      const billAnim = document.getElementById('billAnimation');
      if (billAnim) {
        // Reset animation by removing and re-adding class
        billAnim.classList.remove('marching');
        void billAnim.offsetWidth; // Trigger reflow
        billAnim.classList.add('marching');
        
        // Remove class after animation completes
        setTimeout(() => {
          billAnim.classList.remove('marching');
        }, 6000);
      }
    }

    async function vote(choice) {
      const hasVoted = localStorage.getItem("voted_" + billId);
      if (hasVoted) {
        // Trigger bill animation instead of alert
        triggerBillMarch();
        return;
      }

      try {
        const snapshot = await get(billRef);
        let currentApprove = 0;
        let currentDisapprove = 0;

        if (snapshot.exists()) {
          const data = snapshot.val();
          currentApprove = data.approve || 0;
          currentDisapprove = data.disapprove || 0;
        }

        if (choice === "approve") {
          currentApprove++;
        } else if (choice === "disapprove") {
          currentDisapprove++;
        }

        await set(billRef, {
          approve: currentApprove,
          disapprove: currentDisapprove
        });

        localStorage.setItem("voted_" + billId, choice);

        updatePollDisplay();
        
        // Trigger bill animation after successful vote
        triggerBillMarch();
      } catch (err) {
        console.error("Error submitting vote:", err);
      }
    }

    if (approveBtn) {
      approveBtn.addEventListener("click", () => {
        vote("approve");
      });
    }

    if (disapproveBtn) {
      disapproveBtn.addEventListener("click", () => {
        vote("disapprove");
      });
    }

    updatePollDisplay();

    async function highlightEntities(text, billTitle) {
      const properNounsRef = ref(db, "proper_nouns");

      try {
        const snapshot = await get(properNounsRef);
        if (!snapshot.exists()) return text;

        const data = snapshot.val();
        let billEntities = null;

        for (const key in data) {
          if (data[key].bill_title === billTitle) {
            billEntities = data[key].entities;
            break;
          }
        }

        if (!billEntities || !Array.isArray(billEntities) || billEntities.length === 0) {
          console.log("No entities found for this bill");
          return text;
        }

        const sortedEntities = [...billEntities].sort((a, b) => b.word.length - a.word.length);

        let highlightedText = text;

        sortedEntities.forEach(entity => {
          if (!entity.word) return;

          const escapedWord = escapeRegExp(entity.word);
          const regex = new RegExp(`\\b${escapedWord}\\b`, "gi");

          highlightedText = highlightedText.replace(regex, match => `<span class="highlight">${match}</span>`);
        });

        return highlightedText;

      } catch (err) {
        console.error("Error fetching entities:", err);
        return text;
      }
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    async function updateSummary(bill) {
      const summaryDiv = document.getElementById("concise");
      if (!summaryDiv) return;

      let summaryText = bill.summary || "";

      summaryText = await highlightEntities(summaryText, bill.title);
      summaryDiv.innerHTML = summaryText;
    }

    async function loadBillAndSentiment() {
      if (!billId) {
        container.innerHTML = "<p>No bill ID provided.</p>";
        return;
      }

      fetch('words.json')
        .then(response => response.json())
        .then(words => {
          console.log(words);
        });

      const billRef = ref(db, `congress/bills/${billId}`);

      try {
        const billSnap = await get(billRef);
        if (!billSnap.exists()) {
          container.innerHTML = "<p>Bill not found.</p>";
          return;
        }

        const bill = billSnap.val();
        billTitle = bill.title;

        container.innerHTML = `
          <div class="bill-details">
            <h1>${bill.title}</h1>
            <div class="bill-details-grid">
              <p><strong>Number:</strong> ${bill.number}</p>
              <p><strong>Type:</strong> ${bill.type}</p>
              <p><strong>Action Date:</strong> ${bill.actionDate || 'N/A'}</p>
              <p><strong>Update Date:</strong> ${bill.updateDate || 'N/A'}</p>
            </div>
            <div class="bill-details-links">
              <a href="${bill.url}" target="_blank">Read more on Congress.gov ‚Üí</a>
              <a href="./index.html">Go back to all bills ‚Üí</a>
            </div>
          </div>
        `;

        const billSummary = document.getElementById("concise")

        updateSummary(bill);
        await loadInteractiveQuiz();


        const sentimentSnap = await get(ref(db, 'sentiment'));
        if (sentimentSnap.exists()) {
          const sentiments = sentimentSnap.val();

          for (const query_text in sentiments) {
            const entry = sentiments[query_text];

            if (normalizeText(entry.query_text) === normalizeText(bill.title)) {
              const bbcScore = entry.bbc_com?.average_sentiment ?? 0;
              const reutersScore = entry.reuters_com?.average_sentiment ?? 0;
              const bbcConfidence = entry.bbc_com?.average_confidence ?? 0;
              const reutersConfidence = entry.reuters_com?.average_confidence ?? 0;

              document.getElementById('bbc-bar').style.width = `${bbcScore * 50}%`;
              document.getElementById('reuter-bar').style.width = `${reutersScore * 50}%`;

              document.getElementById('bbc-confidence').textContent = `Confidence: ${(bbcConfidence * 100).toFixed(1)}%`;
              document.getElementById('reuter-confidence').textContent = `Confidence: ${(reutersConfidence * 100).toFixed(1)}%`;

              break;
            }
          }
        }

        const themesSnap = await get(ref(db, 'themes'));

        let matchedThemeEntry = null;

        if (themesSnap.exists()) {
          const allThemes = themesSnap.val();

          for (const key in allThemes) {
            const entry = allThemes[key];
            if (normalizeText(entry.bill) === normalizeText(billTitle)) {
              matchedThemeEntry = entry;
              break;
            }
          }

          if (matchedThemeEntry) {
            const bbcThemes = (matchedThemeEntry.theme_bbc || []).map(t => t.theme);
            const reutersThemes = (matchedThemeEntry.theme_reuter || []).map(t => t.theme);

            document.getElementById('bbc-themes').textContent = 
              `Focus Topics: ${bbcThemes.join(", ") || "None"}`;
            document.getElementById('reuter-themes').textContent = 
              `Focus Topics: ${reutersThemes.join(", ") || "None"}`;
          } else {
            document.getElementById('bbc-themes').textContent = 
              "Focus Topics: Not available.";
            document.getElementById('reuter-themes').textContent = 
              "Focus Topics: Not available.";
          }
        }

      } catch (err) {
        console.error("Error:", err);
        document.getElementById('bbc-confidence').textContent = "Error loading sentiment.";
        document.getElementById('reuter-confidence').textContent = "Error loading sentiment.";
      }
    }

    loadBillAndSentiment();

    async function loadPersonal() {
      const personalImpactRef = ref(db, "personal-impact");
      const personalImpactEl = document.getElementById("personal-impact");

      if (!personalImpactEl) return;

      try {
        const snapshot = await get(personalImpactRef);
        if (!snapshot.exists()) {
          personalImpactEl.textContent = "No personal impact data found yet.";
          return;
        }

        const allImpacts = snapshot.val();
        let matchedImpact = null;

        // Match by bill title (normalize for consistent comparison)
        for (const key in allImpacts) {
          const entry = allImpacts[key];
          if (normalizeText(entry.billTitle) === normalizeText(billTitle)) {
            matchedImpact = entry;
            break;
          }
        }

        if (matchedImpact) {
          const impactType = (matchedImpact.impact || "indirect").toLowerCase();
          const impactFactors = matchedImpact.factors || [];
          const userName = matchedImpact.userName || "Unknown User";
          
          // Store the impact type globally
          currentImpactType = impactType;

          // Set button states based on impact type
          filterButtons.forEach(btn => {
            const btnFilter = btn.dataset.filter;
            
            if (btnFilter === impactType) {
              // This button should be active
              btn.classList.add('active');
              btn.classList.remove('disabled');
            } else {
              // Other buttons should be disabled and grayed out
              btn.classList.remove('active');
              btn.classList.add('disabled');
            }
          });

          let impactText = matchedImpact.res || "No explanation available.";

          const startMatch = impactText.match(/how this bill affects/i);
          if (startMatch) {
            impactText = impactText.slice(startMatch.index).trim();
          }

          const endMatch = impactText.match(/\[factors affected:|\[impact type:/i);
          if (endMatch) {
            impactText = impactText.slice(0, endMatch.index).trim();
          }
          
          personalImpactEl.innerHTML = `
            <p><strong>User:</strong> ${userName}</p>
            <p><strong>Impact Type:</strong> ${impactType}</p>
            <p><strong>Factors:</strong> ${
              Array.isArray(impactFactors)
                ? impactFactors.join(", ")
                : impactFactors
            }</p>
            <hr>
            <p>${impactText}</p>
          `;
        } else {
          personalImpactEl.textContent = "No personal impact data found for this bill.";
        }
      } catch (err) {
        console.error("Error loading personal impact:", err);
        personalImpactEl.textContent = "Error loading personal impact data.";
      }
    }

    // Initialize by loading personal impact data
    loadPersonal();


    // --- QUIZ SYSTEM ---
    let currentQuestionIndex = 0;
    let quizQuestions = [];
    let billPoints = 0;
    const userId = "tanush"; // or dynamically from auth later

    // Elements
    const quizQuestionEl = document.getElementById("quiz-question");
    const quizAnswerEl = document.getElementById("quiz-answer");
    const showAnswerBtn = document.getElementById("show-answer-btn");
    const correctBtn = document.getElementById("correct-btn");
    const wrongBtn = document.getElementById("wrong-btn");
    const quizControlsEl = document.getElementById("quiz-controls");
    const quizProgressEl = document.getElementById("quiz-progress");
    const quizPointsEl = document.getElementById("quiz-points");

    // Firebase references
    const quizzesRef = ref(db, "quizzes");
    const userPointsRef = ref(db, `bill-points/users/${userId}`);

    // Load quiz for this bill
    async function loadInteractiveQuiz() {
      try {
        const snapshot = await get(quizzesRef);
        if (!snapshot.exists()) {
          quizQuestionEl.textContent = "No quiz data available.";
          return;
        }

        const allQuizzes = snapshot.val();
        const quizKey = titleToQuizKey(billTitle);
        let matchedQuiz = allQuizzes[quizKey];

        if (!matchedQuiz) {
          for (const key in allQuizzes) {
            if (normalizeText(key) === normalizeText(quizKey)) {
              matchedQuiz = allQuizzes[key];
              break;
            }
          }
        }

        if (!matchedQuiz || !matchedQuiz.questions) {
          quizQuestionEl.textContent = "No quiz found for this bill.";
          return;
        }

        quizQuestions = Object.values(matchedQuiz.questions);
        currentQuestionIndex = 0;

        await loadUserPoints();
        showQuestion();
      } catch (err) {
        console.error("Error loading quiz:", err);
        quizQuestionEl.textContent = "Error loading quiz data.";
      }
    }

    // Show one question at a time
    function showQuestion() {
      const q = quizQuestions[currentQuestionIndex];
      const quizCard = document.getElementById('quiz-card');
      
      // Reset card to front
      quizCard.classList.remove('flipped');
      
      if (!q) {
        quizQuestionEl.textContent = "üéâ You've finished this quiz!";
        showAnswerBtn.style.display = "none";
        return;
      }

      quizQuestionEl.textContent = q.question;
      quizAnswerEl.textContent = q.correct_answer || "Not provided.";
      quizProgressEl.textContent = `Question ${currentQuestionIndex + 1} of ${quizQuestions.length}`;
      quizPointsEl.textContent = `Bill Points: ${billPoints}`;
    }

    // Show the answer when clicked - flip the card
    showAnswerBtn.addEventListener("click", () => {
      const quizCard = document.getElementById('quiz-card');
      quizCard.classList.add('flipped');
    });

    // Trigger celebration animation
    function triggerCelebration() {
      const celebrationBill = document.getElementById('celebration-bill');
      celebrationBill.classList.add('show');
      
      setTimeout(() => {
        celebrationBill.classList.remove('show');
      }, 1500);
    }

    // Handle correct / wrong clicks
    correctBtn.addEventListener("click", async () => {
      billPoints += 10;
      await updateUserPoints();
      triggerCelebration();
      
      // Wait for celebration to finish before showing next question
      setTimeout(() => {
        nextQuestion();
      }, 1600);
    });

    wrongBtn.addEventListener("click", () => {
      nextQuestion();
    });

    function nextQuestion() {
      currentQuestionIndex++;
      
      // Add a small delay for card flip animation
      const quizCard = document.getElementById('quiz-card');
      quizCard.classList.remove('flipped');
      
      setTimeout(() => {
        showQuestion();
      }, 300);
    }

    // --- BILL POINTS SYSTEM ---
    async function loadUserPoints() {
      const snap = await get(userPointsRef);
      if (snap.exists()) {
        const data = snap.val();
        billPoints = data.totalPoints || 0;
      } else {
        billPoints = 0;
      }
      quizPointsEl.textContent = `Bill Points: ${billPoints}`;
    }

    async function updateUserPoints() {
      try {
        await set(userPointsRef, {
          totalPoints: billPoints,
          lastBill: billTitle,
          lastUpdated: new Date().toISOString()
        });
      } catch (err) {
        console.error("Error updating bill points:", err);
      }
    }

  </script>
</body>
</html>