<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Orwell</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="bill.css">
  
  <style>
    /* Additional styles for impact filter buttons */
    .impact-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .impact-filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .impact-filter-btn {
      padding: 0.5rem 1rem;
      background: transparent;
      color: #d17a5c;
      border: 2px solid #d17a5c;
      border-radius: 20px;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      letter-spacing: -0.01em;
      white-space: nowrap;
    }

    .impact-filter-btn:hover {
      background: rgba(209, 122, 92, 0.1);
      color: #d17a5c;
      border-color: #d17a5c;
      transform: translateY(-1px);
    }

    .impact-filter-btn.active {
      background: #d17a5c;
      color: #ffffff;
      border-color: #d17a5c;
    }

    .impact-filter-btn.disabled {
      background: #f3f1ee;
      color: #b8b3aa;
      border-color: #e8e5e1;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .impact-filter-btn.disabled:hover {
      background: #f3f1ee;
      color: #b8b3aa;
      border-color: #e8e5e1;
      transform: none;
    }

    .impact-content {
      padding-top: 1rem;
      border-top: 1px solid #e8e5e1;
    }

    .impact-message {
      font-size: 1.1rem;
      color: #666;
      padding: 2rem 1rem;
      text-align: center;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .impact-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .impact-filters {
        width: 100%;
      }

      .impact-filter-btn {
        flex: 1;
        text-align: center;
        font-size: 0.75rem;
        padding: 0.6rem 0.75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Bill Character with Helmet -->
  <div id="billAnimation">
    <div class="bill-character">
      <div class="bill-body">
        <div class="bill-lines">
          <div class="bill-line"></div>
          <div class="bill-line"></div>
          <div class="bill-line"></div>
          <div class="bill-line"></div>
        </div>
        <div class="bill-arm arm-left"></div>
        <div class="bill-arm arm-right"></div>
        <div class="bill-leg leg-left"></div>
        <div class="bill-leg leg-right"></div>
        <div class="bill-face">
          <div class="bill-eye eye-left"></div>
          <div class="bill-eye eye-right"></div>
          <div class="bill-smile"></div>
        </div>
      </div>
      <div class="bill-helmet">
        <div class="helmet-star">⭐</div>
        <div class="helmet-rim"></div>
      </div>
    </div>
  </div>

  <div id="bill-details">Loading...</div>

  <div class="row2">
    <div class="summary">
      <h2>Here's a bite-sized review : ) </h2>
      <div id="concise">ML generated summary that Tanush is supposed to generate goes here</div>
    </div>

    <div class="sentiment-analysis">
      <h2> How does media feel?</h2>

      <div class="sentiment-bar" id="bbc-section">
        <div class="source-title">BBC News</div>
        <div class="bar">
          <div id="bbc-bar" class="fill bbc-color" style="width: 0%"></div>
        </div>
        <div class="confidence-text" id="bbc-confidence">Confidence: Loading...</div>
        <div class="themes" id="bbc-themes">focus topics: Loading...</div>
      </div>

      <div class="sentiment-bar" id="reuters-section">
        <div class="source-title">Reuters</div>
        <div class="bar">
          <div id="reuter-bar" class="fill reuter-color" style="width: 0%"></div>
        </div>
        <div class="confidence-text" id="reuter-confidence">Confidence: Loading...</div>
        <div class="themes" id="reuter-themes">focus topics: Loading...</div>
      </div>
    </div>
  </div>

  <div class="personal-impact">
    <div class="impact-header">
      <h2> And what?</h2>
      <div class="impact-filters">
        <button class="impact-filter-btn" data-filter="direct">Directly Affects You</button>
        <button class="impact-filter-btn" data-filter="indirect">Indirectly Affects You</button>
        <button class="impact-filter-btn" data-filter="none">Affects Your Community</button>
      </div>
    </div>
    <div class="impact-content" id="impact-content">
      <p id="personal-impact">Loading impact data...</p>
    </div>
  </div>

  <div class="row-3">
    <div class="gen-quiz">
      <h2>Quiz</h2>
      <p>generated Quiz lives here</p>
    </div>

    <div class="poll-container">
      <h2 class="poll-title"> Orwell Community Vote</h2>
      <div class="poll-content-row">
        <div class="poll-details">
          <div class="poll-buttons">
            <button class="poll-btn approve-btn" id="approveButton">Approve</button>
            <button class="poll-btn disapprove-btn" id="disapproveButton">Disapprove</button>
          </div>
          <div class="poll-bar-container">
            <div class="poll-bar approve-bar" style="width: 0%;"></div>
            <div class="poll-bar disapprove-bar" style="width: 0%;"></div>
          </div>
          <p class="poll-result">0% Approve, 0% Disapprove</p>
        </div>

        <div class="pie-chart-container">
          <canvas id="votePieChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">

    function normalizeText(str) {
      return str
        .replace(/['"]/g, '')
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase();
    }

    let billTitle = ""
    let currentImpactType = ""; // Store the impact type from Firebase
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCS07UgX2GnmuufEQET-RYOtm8i0XaZkWk",
      authDomain: "orwell-ea558.firebaseapp.com",
      databaseURL: "https://orwell-ea558-default-rtdb.firebaseio.com",
      projectId: "orwell-ea558",
      storageBucket: "orwell-ea558.firebasestorage.app",
      messagingSenderId: "301391502605",
      appId: "1:301391502605:web:67c58902e72044cd03a444"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const container = document.getElementById('bill-details');
    const billId = getQueryParam("id") || "unknownBill";
    const billRef = ref(db, "votes/" + billId);

    const pollContainer = document.querySelector(".poll-container");
    const approveBtn = document.getElementById('approveButton');
    const disapproveBtn = document.getElementById('disapproveButton');
    const pollResult = pollContainer.querySelector(".poll-result");
    const approveBar = pollContainer.querySelector(".approve-bar");
    const disapproveBar = pollContainer.querySelector(".disapprove-bar");

    // Impact filter functionality
    const filterButtons = document.querySelectorAll('.impact-filter-btn');
    const impactContent = document.getElementById('impact-content');
    const personalImpactEl = document.getElementById('personal-impact');

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Only allow clicking if it's not disabled
        if (button.classList.contains('disabled')) {
          return;
        }
        
        // Remove active class from all buttons
        filterButtons.forEach(btn => btn.classList.remove('active'));
        
        // Add active class to clicked button
        button.classList.add('active');
        
        // Get filter type
        const filterType = button.dataset.filter;
        
        // Update content based on filter
        updateImpactContent(filterType);
      });
    });

    function updateImpactContent(filterType) {
      if (filterType === 'direct') {
        impactContent.innerHTML = '<div class="impact-message">Tanush is not directly impacted by this bill.</div>';
      } else if (filterType === 'indirect') {
        // Show the personal impact data
        impactContent.innerHTML = '<p id="personal-impact">Loading personal impact data...</p>';
        loadPersonal();
      } else if (filterType === 'none') {
        impactContent.innerHTML = '<div class="impact-message">This bill does have an indirect impact on Tanush!</div>';
      }
    }

    let chartInstance = null;

    async function updatePollDisplay() {
      try {
        const snapshot = await get(billRef);
        let approveVotes = 0;
        let disapproveVotes = 0;

        if (snapshot.exists()) {
          const data = snapshot.val();
          approveVotes = data.approve || 0;
          disapproveVotes = data.disapprove || 0;
        }

        const total = approveVotes + disapproveVotes;
        const approvePercent = total === 0 ? 0 : Math.round((approveVotes / total) * 100);
        const disapprovePercent = total === 0 ? 0 : Math.round((disapproveVotes / total) * 100);

        pollResult.textContent = `${approvePercent}% Approve, ${disapprovePercent}% Disapprove`;

        approveBar.style.width = approvePercent + "%";
        disapproveBar.style.width = disapprovePercent + "%";

        const ctx = document.getElementById("votePieChart").getContext("2d");

        if (chartInstance) {
          chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
          type: "pie",
          data: {
            labels: ["Approve", "Disapprove"],
            datasets: [{
              data: [approveVotes, disapproveVotes],
              backgroundColor: ["#5c7cd1", "#d17a5c"],
              borderWidth: 2,
              borderColor: "#fff"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: "bottom",
                labels: {
                  color: "#6c757d",
                  font: { size: 12, family: "'Inter', sans-serif" },
                  padding: 15
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const percent = total === 0 ? 0 : Math.round((value / total) * 100);
                    return `${label}: ${value} (${percent}%)`;
                  }
                }
              }
            }
          }
        });
      } catch (err) {
        console.error("Error loading poll data:", err);
      }
    }

    async function vote(choice) {
      const hasVoted = localStorage.getItem("voted_" + billId);
      if (hasVoted) {
        alert("You've already voted on this bill!");
        return;
      }

      try {
        const snapshot = await get(billRef);
        let currentApprove = 0;
        let currentDisapprove = 0;

        if (snapshot.exists()) {
          const data = snapshot.val();
          currentApprove = data.approve || 0;
          currentDisapprove = data.disapprove || 0;
        }

        if (choice === "approve") {
          currentApprove++;
        } else if (choice === "disapprove") {
          currentDisapprove++;
        }

        await set(billRef, {
          approve: currentApprove,
          disapprove: currentDisapprove
        });

        localStorage.setItem("voted_" + billId, choice);

        updatePollDisplay();
      } catch (err) {
        console.error("Error submitting vote:", err);
      }
    }

    if (approveBtn) {
      approveBtn.addEventListener("click", () => {
        vote("approve");
      });
    }

    if (disapproveBtn) {
      disapproveBtn.addEventListener("click", () => {
        vote("disapprove");
      });
    }

    updatePollDisplay();

    async function highlightEntities(text, billTitle) {
      const properNounsRef = ref(db, "proper_nouns");

      try {
        const snapshot = await get(properNounsRef);
        if (!snapshot.exists()) return text;

        const data = snapshot.val();
        let billEntities = null;

        for (const key in data) {
          if (data[key].bill_title === billTitle) {
            billEntities = data[key].entities;
            break;
          }
        }

        if (!billEntities || !Array.isArray(billEntities) || billEntities.length === 0) {
          console.log("No entities found for this bill");
          return text;
        }

        const sortedEntities = [...billEntities].sort((a, b) => b.word.length - a.word.length);

        let highlightedText = text;

        sortedEntities.forEach(entity => {
          if (!entity.word) return;

          const escapedWord = escapeRegExp(entity.word);
          const regex = new RegExp(`\\b${escapedWord}\\b`, "gi");

          highlightedText = highlightedText.replace(regex, match => `<span class="highlight">${match}</span>`);
        });

        return highlightedText;

      } catch (err) {
        console.error("Error fetching entities:", err);
        return text;
      }
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    async function updateSummary(bill) {
      const summaryDiv = document.getElementById("concise");
      if (!summaryDiv) return;

      let summaryText = bill.summary || "";

      summaryText = await highlightEntities(summaryText, bill.title);
      summaryDiv.innerHTML = summaryText;
    }

    async function loadBillAndSentiment() {
      if (!billId) {
        container.innerHTML = "<p>No bill ID provided.</p>";
        return;
      }

      fetch('words.json')
        .then(response => response.json())
        .then(words => {
          console.log(words);
        });

      const billRef = ref(db, `congress/bills/${billId}`);

      try {
        const billSnap = await get(billRef);
        if (!billSnap.exists()) {
          container.innerHTML = "<p>Bill not found.</p>";
          return;
        }

        const bill = billSnap.val();
        billTitle = bill.title;

        container.innerHTML = `
          <div class="bill-details">
            <h1>${bill.title}</h1>
            <p><strong>Number:</strong> ${bill.number}</p>
            <p><strong>Type:</strong> ${bill.type}</p>
            <p><strong>Action Date:</strong> ${bill.actionDate || 'N/A'}</p>
            <p><strong>Update Date:</strong> ${bill.updateDate || 'N/A'}</p>
            <a href="${bill.url}" target="_blank">Read more on Congress.gov →</a>
            <a href="./index.html">Go back to all bills →</a>
          </div>
        `;

        const billSummary = document.getElementById("concise")

        updateSummary(bill);

        const sentimentSnap = await get(ref(db, 'sentiment'));
        if (sentimentSnap.exists()) {
          const sentiments = sentimentSnap.val();

          for (const query_text in sentiments) {
            const entry = sentiments[query_text];

            if (normalizeText(entry.query_text) === normalizeText(bill.title)) {
              const bbcScore = entry.bbc_com?.average_sentiment ?? 0;
              const reutersScore = entry.reuters_com?.average_sentiment ?? 0;
              const bbcConfidence = entry.bbc_com?.average_confidence ?? 0;
              const reutersConfidence = entry.reuters_com?.average_confidence ?? 0;

              document.getElementById('bbc-bar').style.width = `${bbcScore * 50}%`;
              document.getElementById('reuter-bar').style.width = `${reutersScore * 50}%`;

              document.getElementById('bbc-confidence').textContent = `Confidence: ${(bbcConfidence * 100).toFixed(1)}%`;
              document.getElementById('reuter-confidence').textContent = `Confidence: ${(reutersConfidence * 100).toFixed(1)}%`;

              break;
            }
          }
        }

        const themesSnap = await get(ref(db, 'themes'));

        let matchedThemeEntry = null;

        if (themesSnap.exists()) {
          const allThemes = themesSnap.val();

          for (const key in allThemes) {
            const entry = allThemes[key];
            if (normalizeText(entry.bill) === normalizeText(billTitle)) {
              matchedThemeEntry = entry;
              break;
            }
          }

          if (matchedThemeEntry) {
            const bbcThemes = (matchedThemeEntry.theme_bbc || []).map(t => t.theme);
            const reutersThemes = (matchedThemeEntry.theme_reuter || []).map(t => t.theme);

            document.getElementById('bbc-themes').textContent = 
              `Focus Topics: ${bbcThemes.join(", ") || "None"}`;
            document.getElementById('reuter-themes').textContent = 
              `Focus Topics: ${reutersThemes.join(", ") || "None"}`;
          } else {
            document.getElementById('bbc-themes').textContent = 
              "Focus Topics: Not available.";
            document.getElementById('reuter-themes').textContent = 
              "Focus Topics: Not available.";
          }
        }

      } catch (err) {
        console.error("Error:", err);
        document.getElementById('bbc-confidence').textContent = "Error loading sentiment.";
        document.getElementById('reuter-confidence').textContent = "Error loading sentiment.";
      }
    }

    loadBillAndSentiment();

    async function loadPersonal() {
      const personalImpactRef = ref(db, "personal-impact");
      const personalImpactEl = document.getElementById("personal-impact");

      if (!personalImpactEl) return;

      try {
        const snapshot = await get(personalImpactRef);
        if (!snapshot.exists()) {
          personalImpactEl.textContent = "No personal impact data found yet.";
          return;
        }

        const allImpacts = snapshot.val();
        let matchedImpact = null;

        // Match by bill title (normalize for consistent comparison)
        for (const key in allImpacts) {
          const entry = allImpacts[key];
          if (normalizeText(entry.billTitle) === normalizeText(billTitle)) {
            matchedImpact = entry;
            break;
          }
        }

        if (matchedImpact) {
          const impactType = (matchedImpact.impact || "indirect").toLowerCase();
          const impactFactors = matchedImpact.factors || [];
          const userName = matchedImpact.userName || "Unknown User";
          
          // Store the impact type globally
          currentImpactType = impactType;

          // Set button states based on impact type
          filterButtons.forEach(btn => {
            const btnFilter = btn.dataset.filter;
            
            if (btnFilter === impactType) {
              // This button should be active
              btn.classList.add('active');
              btn.classList.remove('disabled');
            } else {
              // Other buttons should be disabled and grayed out
              btn.classList.remove('active');
              btn.classList.add('disabled');
            }
          });

          let impactText = matchedImpact.res || "No explanation available.";

          const startMatch = impactText.match(/how this bill affects/i);
          if (startMatch) {
            impactText = impactText.slice(startMatch.index).trim();
          }

          const endMatch = impactText.match(/\[factors affected:|\[impact type:/i);
          if (endMatch) {
            impactText = impactText.slice(0, endMatch.index).trim();
          }
          
          personalImpactEl.innerHTML = `
            <p><strong>User:</strong> ${userName}</p>
            <p><strong>Impact Type:</strong> ${impactType}</p>
            <p><strong>Factors:</strong> ${
              Array.isArray(impactFactors)
                ? impactFactors.join(", ")
                : impactFactors
            }</p>
            <hr>
            <p>${impactText}</p>
          `;
        } else {
          personalImpactEl.textContent = "No personal impact data found for this bill.";
        }
      } catch (err) {
        console.error("Error loading personal impact:", err);
        personalImpactEl.textContent = "Error loading personal impact data.";
      }
    }

    // Initialize by loading personal impact data
    loadPersonal();

  </script>
</body>
</html>