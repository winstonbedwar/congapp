<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Orwell</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="bill.css">
</head>
<body>
  <!-- Bill Character with Helmet -->
  <div id="billAnimation">
    <div class="bill-character">
      <div class="bill-body">
        <div class="bill-lines">
          <div class="bill-line"></div>
          <div class="bill-line"></div>
          <div class="bill-line"></div>
          <div class="bill-line"></div>
        </div>
        <div class="bill-arm arm-left"></div>
        <div class="bill-arm arm-right"></div>
        <div class="bill-leg leg-left"></div>
        <div class="bill-leg leg-right"></div>
        <div class="bill-face">
          <div class="bill-eye eye-left"></div>
          <div class="bill-eye eye-right"></div>
          <div class="bill-smile"></div>
        </div>
      </div>
      <div class="bill-helmet">
        <div class="helmet-star">‚≠ê</div>
        <div class="helmet-rim"></div>
      </div>
    </div>
  </div>

  <div id="bill-details">Loading...</div>

  <div class="row2">
    <div class="summary">
      <h2>üìÑ AI-Generated Summary</h2>
      <div id="concise">ML generated summary that Tanush is supposed to generate goes here</div>
    </div>

    <div class="sentiment-analysis">
      <h2>üìä Sentiment</h2>

      <div class="sentiment-bar" id="bbc-section">
        <div class="source-title">BBC News</div>
        <div class="bar">
          <div id="bbc-bar" class="fill bbc-color" style="width: 0%"></div>
        </div>
        <div class="confidence-text" id="bbc-confidence">Confidence: Loading...</div>
        <div class="themes" id="bbc-themes">focus topics: Loading...</div>
      </div>

      <div class="sentiment-bar" id="reuters-section">
        <div class="source-title">Reuters</div>
        <div class="bar">
          <div id="reuter-bar" class="fill reuter-color" style="width: 0%"></div>
        </div>
        <div class="confidence-text" id="reuter-confidence">Confidence: Loading...</div>
        <div class="themes" id="reuter-themes">focus topics: Loading...</div>
      </div>
    </div>
  </div>

  <div class="personal-impact">
    <h2>üí≠ How this affects you</h2>
    <p>predictions about how bill impacts them live here</p>
  </div>

  <div class="row-3">
    <div class="gen-quiz">
      <h2>üéØ Quiz</h2>
      <p>generated Quiz lives here</p>
    </div>

    <div class="poll-container">
      <h2 class="poll-title">üó≥Ô∏è Orwell Community Vote</h2>
      <div class="poll-content-row">
        <div class="poll-details">
          <div class="poll-buttons">
            <button class="poll-btn approve-btn" id="approveButton">Approve</button>
            <button class="poll-btn disapprove-btn" id="disapproveButton">Disapprove</button>
          </div>
          <div class="poll-bar-container">
            <div class="poll-bar approve-bar" style="width: 0%;"></div>
            <div class="poll-bar disapprove-bar" style="width: 0%;"></div>
          </div>
          <p class="poll-result">0% Approve, 0% Disapprove</p>
        </div>

        <div class="pie-chart-container">
          <canvas id="votePieChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">

    function normalizeText(str) {
      return str
        .replace(/['"]/g, '')
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase();
    }

    let billTitle = ""
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCS07UgX2GnmuufEQET-RYOtm8i0XaZkWk",
      authDomain: "orwell-ea558.firebaseapp.com",
      databaseURL: "https://orwell-ea558-default-rtdb.firebaseio.com",
      projectId: "orwell-ea558",
      storageBucket: "orwell-ea558.firebasestorage.app",
      messagingSenderId: "301391502605",
      appId: "1:301391502605:web:67c58902e72044cd03a444"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const container = document.getElementById('bill-details');
    const billId = getQueryParam("id") || "unknownBill";
    const billRef = ref(db, "votes/" + billId);

    const pollContainer = document.querySelector(".poll-container");
    const approveBtn = document.getElementById('approveButton');
    const disapproveBtn = document.getElementById('disapproveButton');
    const pollResult = pollContainer.querySelector(".poll-result");
    const approveBar = pollContainer.querySelector(".approve-bar");
    const disapproveBar = pollContainer.querySelector(".disapprove-bar");

    // Bill animation function
    function triggerBillAnimation() {
      
      const bill = document.getElementById('billAnimation');
      
      if (!bill) {
        console.error('‚ùå Bill element not found!');
        return;
      }
      
      // Remove class
      bill.classList.remove('marching');
      
      // Force reflow
      void bill.offsetWidth;
      
      // Add class back
      bill.classList.add('marching');
      
      // Remove after animation
      setTimeout(() => {
        bill.classList.remove('marching');
      }, 6000);
    }

    let voteChart = null;

    async function updatePollDisplay() {
      try {
        const snapshot = await get(billRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          const approve = data.approve || 0;
          const disapprove = data.disapprove || 0;
          const total = approve + disapprove;

          if (total > 0) {
            const approvePercent = ((approve / total) * 100).toFixed(1);
            const disapprovePercent = ((disapprove / total) * 100).toFixed(1);

            approveBar.style.width = `${approvePercent}%`;
            disapproveBar.style.width = `${disapprovePercent}%`;
            pollResult.textContent = `${approvePercent}% Approve, ${disapprovePercent}% Disapprove`;

            const ctx = document.getElementById('votePieChart');
            if (ctx) {
              if (voteChart) {
                voteChart.destroy();
              }

              voteChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                  labels: ['Approve', 'Disapprove'],
                  datasets: [{
                    data: [approve, disapprove],
                    backgroundColor: ['#8ba888', '#c4a07a'],
                    borderColor: ['#ffffff', '#ffffff'],
                    borderWidth: 2
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: true,
                  plugins: {
                    legend: {
                      display: false
                    },
                    tooltip: {
                      backgroundColor: '#1a1a1a',
                      titleFont: {
                        size: 13,
                        weight: '600',
                        family: 'Inter'
                      },
                      bodyFont: {
                        size: 12,
                        family: 'Inter'
                      },
                      padding: 10,
                      callbacks: {
                        label: function(context) {
                          let label = context.label || '';
                          if (label) {
                            label += ': ';
                          }
                          if (context.parsed !== null) {
                            label += context.parsed.toFixed(1) + '%';
                          }
                          return label;
                        }
                      }
                    }
                  }
                }
              });
            }
          }
        }
      } catch (err) {
        console.error("Error with updating poll display:", err);
      }
    }

    async function vote(type) {
      
      try {
        const snapshot = await get(billRef);
        const current = snapshot.exists() ? snapshot.val() : { approve: 0, disapprove: 0 };

        const updates = {
          approve: current.approve || 0,
          disapprove: current.disapprove || 0,
        };

        updates[type] += 1;

        await set(billRef, updates);
        
        triggerBillAnimation();
        
        updatePollDisplay();
      } catch (err) {
        console.error("Error submitting vote:", err);
      }
    }

    if (approveBtn) {
      approveBtn.addEventListener("click", () => {
        vote("approve");
      });
    }

    if (disapproveBtn) {
      disapproveBtn.addEventListener("click", () => {
        vote("disapprove");
      });
    }

    updatePollDisplay();

    async function highlightEntities(text, billTitle) {
      const properNounsRef = ref(db, "proper_nouns");

      try {
        const snapshot = await get(properNounsRef);
        if (!snapshot.exists()) return text;

        const data = snapshot.val();
        let billEntities = null;

        for (const key in data) {
          if (data[key].bill_title === billTitle) {
            billEntities = data[key].entities;
            break;
          }
        }

        if (!billEntities || !Array.isArray(billEntities) || billEntities.length === 0) {
          console.log("No entities found for this bill");
          return text;
        }

        const sortedEntities = [...billEntities].sort((a, b) => b.word.length - a.word.length);

        let highlightedText = text;

        sortedEntities.forEach(entity => {
          if (!entity.word) return;

          const escapedWord = escapeRegExp(entity.word);
          const regex = new RegExp(`\\b${escapedWord}\\b`, "gi");

          highlightedText = highlightedText.replace(regex, match => `<span class="highlight">${match}</span>`);
        });

        return highlightedText;

      } catch (err) {
        console.error("Error fetching entities:", err);
        return text;
      }
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    async function updateSummary(bill) {
      const summaryDiv = document.getElementById("concise");
      if (!summaryDiv) return;

      let summaryText = bill.summary || "";

      summaryText = await highlightEntities(summaryText, bill.title);
      summaryDiv.innerHTML = summaryText;
    }

    async function loadBillAndSentiment() {
      if (!billId) {
        container.innerHTML = "<p>No bill ID provided.</p>";
        return;
      }

      fetch('words.json')
        .then(response => response.json())
        .then(words => {
          console.log(words);
        });

      const billRef = ref(db, `congress/bills/${billId}`);

      try {
        const billSnap = await get(billRef);
        if (!billSnap.exists()) {
          container.innerHTML = "<p>Bill not found.</p>";
          return;
        }

        const bill = billSnap.val();
        billTitle = bill.title;

        container.innerHTML = `
          <div class="bill-details">
            <h1>${bill.title}</h1>
            <p><strong>Number:</strong> ${bill.number}</p>
            <p><strong>Type:</strong> ${bill.type}</p>
            <p><strong>Action Date:</strong> ${bill.actionDate || 'N/A'}</p>
            <p><strong>Update Date:</strong> ${bill.updateDate || 'N/A'}</p>
            <a href="${bill.url}" target="_blank">Read more on Congress.gov ‚Üí</a>
            <a href="./index.html">Go back to all bills ‚Üí</a>
          </div>
        `;

        const billSummary = document.getElementById("concise")

        updateSummary(bill);

        const sentimentSnap = await get(ref(db, 'sentiment'));
        if (sentimentSnap.exists()) {
          const sentiments = sentimentSnap.val();

          for (const query_text in sentiments) {
            const entry = sentiments[query_text];

            if (normalizeText(entry.query_text) === normalizeText(bill.title)) {
              const bbcScore = entry.bbc_com?.average_sentiment ?? 0;
              const reutersScore = entry.reuters_com?.average_sentiment ?? 0;
              const bbcConfidence = entry.bbc_com?.average_confidence ?? 0;
              const reutersConfidence = entry.reuters_com?.average_confidence ?? 0;

              document.getElementById('bbc-bar').style.width = `${bbcScore * 50}%`;
              document.getElementById('reuter-bar').style.width = `${reutersScore * 50}%`;

              document.getElementById('bbc-confidence').textContent = `Confidence: ${(bbcConfidence * 100).toFixed(1)}%`;
              document.getElementById('reuter-confidence').textContent = `Confidence: ${(reutersConfidence * 100).toFixed(1)}%`;

              break;
            }
          }
        }

        const themesSnap = await get(ref(db, 'themes'));

        let matchedThemeEntry = null;

        if (themesSnap.exists()) {
          const allThemes = themesSnap.val();

          for (const key in allThemes) {
            const entry = allThemes[key];
            if (normalizeText(entry.bill) === normalizeText(billTitle)) {
              matchedThemeEntry = entry;
              break;
            }
          }

          if (matchedThemeEntry) {
            const bbcThemes = (matchedThemeEntry.theme_bbc || []).map(t => t.theme);
            const reutersThemes = (matchedThemeEntry.theme_reuter || []).map(t => t.theme);

            document.getElementById('bbc-themes').textContent = 
              `Focus Topics: ${bbcThemes.join(", ") || "None"}`;
            document.getElementById('reuter-themes').textContent = 
              `Focus Topics: ${reutersThemes.join(", ") || "None"}`;
          } else {
            document.getElementById('bbc-themes').textContent = 
              "Focus Topics: Not available.";
            document.getElementById('reuter-themes').textContent = 
              "Focus Topics: Not available.";
          }
        }

      } catch (err) {
        console.error("Error:", err);
        document.getElementById('bbc-confidence').textContent = "Error loading sentiment.";
        document.getElementById('reuter-confidence').textContent = "Error loading sentiment.";
      }
    }

    loadBillAndSentiment();

  </script>
</body>
</html>